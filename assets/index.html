<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; script-src 'self' 'unsafe-inline'">
  <title>Site Blocker</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="titlebar-drag"></div>

  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1 class="title">Site Blocker</h1>
      <span id="status-badge" class="badge badge-inactive">Inactive</span>
    </div>

    <!-- Toggle -->
    <div class="toggle-row">
      <span class="toggle-label">Block sites</span>
      <label class="toggle-switch">
        <input type="checkbox" id="toggle-blocking">
        <span class="toggle-track"></span>
      </label>
    </div>

    <!-- Add domain -->
    <div class="input-row">
      <input
        type="text"
        id="domain-input"
        class="domain-input"
        placeholder="example.com"
        autocomplete="off"
        spellcheck="false"
      >
      <button id="btn-add" class="btn-add">Add</button>
    </div>

    <!-- Domain list -->
    <div id="domain-list" class="domain-list"></div>

    <!-- Access log -->
    <div class="log-section">
      <div class="log-header">
        <span class="log-title">Recent Access Attempts</span>
        <span id="access-log-count" class="log-count"></span>
      </div>
      <div id="access-log-list" class="access-log-list"></div>
    </div>

    <!-- Footer -->
    <div class="footer">
      <span id="domain-count" class="domain-count"></span>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <script>
    const api = window.siteBlocker;
    const domainList = document.getElementById('domain-list');
    const domainInput = document.getElementById('domain-input');
    const btnAdd = document.getElementById('btn-add');
    const toggleBlocking = document.getElementById('toggle-blocking');
    const statusBadge = document.getElementById('status-badge');
    const domainCount = document.getElementById('domain-count');
    const accessLogList = document.getElementById('access-log-list');
    const accessLogCount = document.getElementById('access-log-count');
    const toast = document.getElementById('toast');

    let toastTimer = null;
    let refreshInFlight = false;

    function showToast(msg) {
      toast.textContent = msg;
      toast.classList.add('visible');
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => toast.classList.remove('visible'), 2500);
    }

    // Access log: domain -> last attempt timestamp
    let accessLogMap = {};

    function normalizeDomainForLookup(domain) {
      return String(domain || '').toLowerCase().replace(/^www\./, '');
    }

    function escapeHtml(text) {
      return String(text || '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    function formatStreak(lastTs) {
      if (!lastTs) return null;
      const elapsed = Date.now() - new Date(lastTs).getTime();
      if (elapsed < 0) return 'just now';
      const minutes = Math.floor(elapsed / 60000);
      const hours = Math.floor(minutes / 60);
      const days = Math.floor(hours / 24);

      const parts = [];
      if (days > 0) parts.push(`${days} day${days === 1 ? '' : 's'}`);
      if (hours % 24 > 0) parts.push(`${hours % 24} hour${hours % 24 === 1 ? '' : 's'}`);
      if (parts.length === 0) parts.push(`${Math.max(minutes, 1)} min`);
      return parts.join(', ') + ' clean';
    }

    function formatRelative(ts) {
      const elapsed = Date.now() - new Date(ts).getTime();
      if (!Number.isFinite(elapsed) || elapsed < 0) return 'just now';
      const minutes = Math.floor(elapsed / 60000);
      if (minutes < 1) return 'just now';
      if (minutes < 60) return `${minutes}m ago`;
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return `${hours}h ago`;
      const days = Math.floor(hours / 24);
      return `${days}d ago`;
    }

    function formatAbsolute(ts) {
      const d = new Date(ts);
      if (Number.isNaN(d.getTime())) return ts;
      return d.toLocaleString();
    }

    function renderAccessLog(entries) {
      const sorted = [...entries].sort((a, b) => new Date(b.ts) - new Date(a.ts));
      const visible = sorted.slice(0, 30);
      accessLogCount.textContent = `${entries.length} ${entries.length === 1 ? 'entry' : 'entries'}`;

      if (visible.length === 0) {
        accessLogList.innerHTML = '<div class="empty-state compact"><span class="empty-state-text">No attempts yet</span></div>';
        return;
      }

      accessLogList.innerHTML = visible.map((entry) => {
        const domain = escapeHtml(entry.domain);
        const abs = escapeHtml(formatAbsolute(entry.ts));
        const rel = escapeHtml(formatRelative(entry.ts));
        return `
          <div class="log-entry">
            <span class="log-entry-domain">${domain}</span>
            <span class="log-entry-time" title="${abs}">${rel}</span>
          </div>
        `;
      }).join('');
    }

    function renderDomains(domains) {
      if (domains.length === 0) {
        domainList.innerHTML = '<div class="empty-state"><span class="empty-state-text">No domains yet</span></div>';
        domainCount.textContent = '';
        return;
      }

      const sorted = [...domains].sort();
      domainList.innerHTML = sorted.map(d => {
        const lastTs = accessLogMap[normalizeDomainForLookup(d)];
        const streak = formatStreak(lastTs);
        const streakHtml = streak
          ? `<span class="domain-streak">${streak}</span>`
          : '<span class="domain-streak no-data">No attempts logged</span>';
        return `
          <div class="domain-card" data-domain="${d}">
            <div class="domain-info">
              <span class="domain-name">${d}</span>
              ${streakHtml}
            </div>
            <button class="btn-remove" title="Remove ${d}">&times;</button>
          </div>
        `;
      }).join('');

      domainCount.textContent = `${domains.length} domain${domains.length === 1 ? '' : 's'}`;
    }

    function updateBadge(active) {
      statusBadge.textContent = active ? 'Active' : 'Inactive';
      statusBadge.className = active ? 'badge badge-active' : 'badge badge-inactive';
      toggleBlocking.checked = active;
    }

    async function refresh() {
      if (refreshInFlight) return;
      refreshInFlight = true;
      try {
        const [domains, active, logEntries] = await Promise.all([
          api.getDomains(),
          api.getStatus(),
          api.getAccessLog()
        ]);

        // Build map: domain -> most recent timestamp
        accessLogMap = {};
        for (const entry of logEntries) {
          const key = normalizeDomainForLookup(entry.domain);
          const prev = accessLogMap[key];
          if (!prev || entry.ts > prev) {
            accessLogMap[key] = entry.ts;
          }
        }

        renderDomains(domains);
        renderAccessLog(logEntries);
        updateBadge(active);
      } catch (err) {
        showToast('Failed to load data');
      } finally {
        refreshInFlight = false;
      }
    }

    // Add domain
    async function handleAdd() {
      const val = domainInput.value.trim();
      if (!val) return;

      try {
        const added = await api.addDomain(val);
        domainInput.value = '';
        if (added.length === 0) {
          showToast('Already in list');
        }
        await refresh();
      } catch (err) {
        showToast(err.message || 'Invalid domain');
      }
    }

    btnAdd.addEventListener('click', handleAdd);
    domainInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') handleAdd();
    });

    // Remove domain
    domainList.addEventListener('click', async (e) => {
      const btn = e.target.closest('.btn-remove');
      if (!btn) return;
      const card = btn.closest('.domain-card');
      const domain = card.dataset.domain;

      try {
        await api.removeDomain(domain);
        await refresh();
      } catch (err) {
        showToast(err.message || 'Failed to remove');
      }
    });

    // Toggle blocking
    toggleBlocking.addEventListener('change', async () => {
      const shouldEnable = toggleBlocking.checked;
      try {
        if (shouldEnable) {
          await api.enableBlocking();
        } else {
          await api.disableBlocking();
        }
        await refresh();
      } catch (err) {
        // Revert toggle on failure (user cancelled auth)
        toggleBlocking.checked = !shouldEnable;
        showToast(err.message || 'Operation cancelled');
      }
    });

    // Initial load
    refresh();
    setInterval(refresh, 15000);
  </script>
</body>
</html>
